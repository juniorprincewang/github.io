---
title: 编写Linux内核模块
date: 2018-11-16 19:37:38
tags:
- kernel
categories:
- linux
---
Linux 内核模块是设备和用户应用程序之间的桥梁，可以通过标准系统调用，为应用程序屏蔽设备细节。本篇文章就记录下写内核模块需要注意的点。
<!-- more -->


# 内核模块和应用程序区别
内核模块不是应用程序，从一开始就没有 main() 函数。内核模块和普通应用程序的区别有： 

+ 非顺序执行：
		内核模块使用初始化函数将自身注册并处理请求，初始化函数运行后就结束了。
		内核模块处理的请求在模块代码中定义。这和常用于图形用户界面（graphical-user interface，GUI）应用的事件驱动编程模型比较类似。 
+ 没有自动清理：
		任何由内核模块申请的内存，必须要模块卸载时手动释放，否则这些内存将无法使用，直到系统重启。 
+ 不要使用 printf() 函数：
		内核代码无法访问为 Linux 用户空间编写的库。内核模块运行在内核空间，它有自己独立的地址空间。内核空间和用户空间的接口被清晰的定义和控制。
		内核模块可以通过 printk() 函数输出信息，这些输出可以在用户空间查看到。 
+ 会被中断：
		内核模块一个概念上困难的地方在于他们可能会同时被多个程序 / 进程使用。构建内核模块时需要小心，以确保在发生中断的时候行为一致和正确。
+ 更高级的执行特权：
		通常内核模块会比用户空间程序分配更多的 CPU 周期。这看上去是一个优势，然而需要特别注意内核模块不会影响到系统的综合性能。
+ 无浮点支持：
		对用户空间应用，内核代码使用陷阱（trap）来实现整数到浮点模式的转换。然而在内核空间中这些陷阱难以使用。
		替代方案是手工保存和恢复浮点运算，这是最好的避免方式，并将处理留给用户空间代码。


# 参考
1. [Writing a Linux Kernel Module — Part 1: Introduction](http://derekmolloy.ie/writing-a-linux-kernel-module-part-1-introduction/)
2. [编写Linux内核模块——第一部分：前言](http://www.infoq.com/cn/articles/linux-kernel-module-part01)